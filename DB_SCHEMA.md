# ğŸ“„ DB_SCHEMAï¼šä½¿ç”¨è€…ï¼ˆuserï¼‰è³‡æ–™è¡¨

SimpleChat å¾Œç«¯ç›®å‰ä»¥ SQLite ä½œç‚ºé è¨­å„²å­˜ï¼Œç¬¬ä¸€å€‹å®Œæˆçš„è³‡æ–™è¡¨æ˜¯ `user`ã€‚æ­¤è¡¨ç”¨æ–¼å„²å­˜ç™»å…¥å¸³è™Ÿã€å¯†ç¢¼ï¼ˆbcrypt é›œæ¹Šï¼‰ã€è§’è‰²èˆ‡é¡¯ç¤ºè³‡æ–™ï¼Œæ­é… JWT å–å¾—/é©—è­‰å­˜å–æ¬Šé™ã€‚

## è³‡æ–™è¡¨çµæ§‹

| æ¬„ä½åç¨±        | å‹åˆ¥ / ç´„æŸ                                   | èªªæ˜ |
|-----------------|-----------------------------------------------|------|
| `id`            | `INTEGER PRIMARY KEY AUTOINCREMENT`           | ä½¿ç”¨è€…å”¯ä¸€è­˜åˆ¥ç¢¼ï¼ˆè‡ªå‹•éå¢ï¼‰ |
| `email`         | `TEXT UNIQUE NOT NULL`                        | ç™»å…¥å¸³è™Ÿï¼ˆEmailï¼‰ï¼Œå…¨åŸŸå”¯ä¸€ï¼›ç”¨æ–¼ç™»å…¥èˆ‡é€šçŸ¥ |
| `password_hash` | `TEXT NOT NULL`                               | ä»¥ bcrypt æ¼”ç®—æ³•ç”¢ç”Ÿçš„å¯†ç¢¼é›œæ¹Šå€¼ï¼Œæ°¸é ä¸è¦å„²å­˜æ˜ç¢¼ |
| `role`          | `TEXT NOT NULL DEFAULT 'user'`                | æ¬Šé™è§’è‰²ï¼Œå¯è‡ªè¨‚ï¼ˆå¦‚ `admin`ã€`operator` ç­‰ï¼‰ï¼Œé è¨­ `user`ã€‚ç•¶è³‡æ–™åº«å°šæœªæœ‰ä½¿ç”¨è€…æ™‚ï¼Œç¬¬ä¸€ä½è¨»å†Šè€…æœƒè‡ªå‹•è¢«å‡ç‚º `admin` |
| `display_name`  | `TEXT`                                        | é¡¯ç¤ºåç¨±ï¼Œå¯ç”¨æ–¼ UI ä¸Šé¡¯ç¤ºæš±ç¨± |
| `created_at`    | `TEXT NOT NULL DEFAULT CURRENT_TIMESTAMP`     | å»ºç«‹æ™‚é–“ï¼ˆISO8601 å­—ä¸²ï¼‰ï¼Œç”± SQLite è‡ªå‹•ç”¢ç”Ÿ |
| `last_login_at` | `TEXT`                                        | æœ€è¿‘ç™»å…¥æ™‚é–“ï¼ˆISO8601 å­—ä¸²ï¼‰ï¼Œç™»å…¥æˆåŠŸæ™‚ç”±å¾Œç«¯æ›´æ–° |

> SQLite ä»¥ `TEXT` å„²å­˜æ™‚é–“ï¼ŒFastAPI æœƒå‚³å› ISO8601 æ ¼å¼ä¸¦æ–¼ç™»å…¥æ™‚å¯«å…¥ `datetime.utcnow().isoformat()`ã€‚

## ç¯„ä¾‹è³‡æ–™

| id | email              | password_hash                                 | role  | display_name | created_at                | last_login_at             |
|----|--------------------|-----------------------------------------------|-------|--------------|---------------------------|---------------------------|
| 1  | admin@example.com  | `$2b$12$91N8...`                              | admin | ç³»çµ±ç®¡ç†å“¡   | 2025-02-20T10:12:03.000Z | 2025-02-22T08:45:10.000Z |
| 2  | user@example.com   | `$2b$12$uL7p...`                              | user  | Alice        | 2025-02-21T04:01:55.000Z | 2025-02-21T09:30:42.000Z |

## ä½¿ç”¨æ–¹å¼æ‘˜è¦
1. è¨»å†Š/å»ºç«‹å¸³è™Ÿæ™‚ï¼Œå¾Œç«¯ä»¥ bcrypt å°‡å¯†ç¢¼è½‰æˆ `password_hash` å¾Œå¯«å…¥ `user` è¡¨ã€‚
2. ç™»å…¥æ™‚ï¼Œå¾Œç«¯ä»¥ Email æŸ¥è©¢ `user` è¡¨ï¼Œä½¿ç”¨ bcrypt é©—è­‰å¯†ç¢¼ã€‚
3. é©—è­‰æˆåŠŸå¾Œï¼Œç”¢ç”Ÿ JWT `access_token` å›å‚³çµ¦å‰ç«¯ï¼›åŒæ™‚æ›´æ–° `last_login_at`ã€‚
4. å¾ŒçºŒ API é€é JWT ä¸­çš„ `sub`ï¼ˆä½¿ç”¨è€… email æˆ– idï¼‰è¾¨è­˜ä½¿ç”¨è€…ï¼Œé€²è€Œé—œè¯èŠå¤©è¨˜éŒ„ã€æª”æ¡ˆä¸Šå‚³ç´€éŒ„ç­‰å…¶é¤˜è¡¨æ ¼ã€‚

æœªä¾†è‹¥éœ€è¦å¢åŠ æ¬„ä½ï¼ˆä¾‹å¦‚å¤šå› ç´ é©—è­‰ã€å¸³è™Ÿç‹€æ…‹ç­‰ï¼‰ï¼Œå¯åœ¨æ­¤æª”æ¡ˆæŒçºŒæ›´æ–°ï¼Œä¸¦åŒæ­¥èª¿æ•´ `backend/database.py` çš„å»ºè¡¨ SQLã€‚

---

# ğŸ“„ DB_SCHEMAï¼šmessages / message_fileï¼ˆæ­·å²å°è©±èˆ‡é™„ä»¶ï¼‰

`messages` è¡¨ç”¨ä¾†ä¿å­˜æ¯ä½ä½¿ç”¨è€…çš„èŠå¤©ç´€éŒ„ï¼›è‹¥è©²è¨Šæ¯åŒ…å«æª”æ¡ˆï¼Œæœƒåœ¨ `message_file` è¡¨å»ºç«‹å°æ‡‰ç´€éŒ„ã€‚å¯¦éš›æª”æ¡ˆå‰‡å­˜æ”¾æ–¼ `chat_uploads/` ç›®éŒ„ï¼ˆå¯ç”¨ç’°å¢ƒè®Šæ•¸ `CHAT_UPLOAD_ROOT` è¦†è“‹ï¼‰ï¼Œä¸¦ä»¥ `user_<ä½¿ç”¨è€…ID>/` ç‚ºå­è³‡æ–™å¤¾ï¼Œä»¥ç¢ºä¿æª”æ¡ˆéš”é›¢ï¼š

```
backend/
â”œâ”€â”€ chat_uploads/
â”‚   â”œâ”€â”€ user_1/
â”‚   â”‚   â””â”€â”€ <uuid>_åŸå§‹æª”å.pdf
â”‚   â””â”€â”€ user_2/
â”‚       â””â”€â”€ <uuid>_åŸå§‹æª”å.png
â””â”€â”€ ...
```

## messages è¡¨

| æ¬„ä½åç¨±     | å‹åˆ¥ / ç´„æŸ                                                     | èªªæ˜ |
|--------------|-----------------------------------------------------------------|------|
| `id`         | `INTEGER PRIMARY KEY AUTOINCREMENT`                             | è¨Šæ¯å”¯ä¸€ ID |
| `user_id`    | `INTEGER NOT NULL REFERENCES user(id) ON DELETE CASCADE`        | è¨Šæ¯æ‰€å±¬ä½¿ç”¨è€… |
| `sender_type`| `TEXT NOT NULL CHECK(sender_type IN ('user','assistant'))`      | è¨Šæ¯ä¾†æºè§’è‰² |
| `content`    | `TEXT NOT NULL`                                                 | æ–‡å­—å…§å®¹ |
| `created_at` | `TEXT NOT NULL DEFAULT CURRENT_TIMESTAMP`                       | å»ºç«‹æ™‚é–“ |

## message_file è¡¨

| æ¬„ä½åç¨±     | å‹åˆ¥ / ç´„æŸ                                                     | èªªæ˜ |
|--------------|-----------------------------------------------------------------|------|
| `id`         | `INTEGER PRIMARY KEY AUTOINCREMENT`                             | é™„ä»¶å”¯ä¸€ ID |
| `message_id` | `INTEGER NOT NULL REFERENCES message(id) ON DELETE CASCADE`     | æ‰€å±¬è¨Šæ¯ |
| `file_name`  | `TEXT NOT NULL`                                                 | ä½¿ç”¨è€…ä¸Šå‚³æ™‚çš„åŸå§‹æª”å |
| `file_path`  | `TEXT NOT NULL`                                                 | å„²å­˜è·¯å¾‘ï¼ˆç›¸å°æ–¼ `chat_uploads/`ï¼‰ |
| `mime_type`  | `TEXT`                                                          | ç€è¦½å™¨æä¾›çš„ MIME Type |
| `size_bytes` | `INTEGER`                                                       | æª”æ¡ˆå¤§å°ï¼ˆbytesï¼‰ |
| `created_at` | `TEXT NOT NULL DEFAULT CURRENT_TIMESTAMP`                       | å»ºç«‹æ™‚é–“ |

## æ“ä½œæµç¨‹
1. å‰ç«¯é€å‡ºè¨Šæ¯æ™‚ï¼Œå‘¼å« `POST /api/messages`ï¼Œå‚³å…¥ `content`ã€`sender_type` åŠ `files`ã€‚
2. å¾Œç«¯å»ºç«‹ `messages` ç´€éŒ„ä¸¦å°‡æ¯å€‹é™„ä»¶å¯«å…¥ `chat_uploads/user_<id>/`ï¼Œæª”åä»¥ `UUID_åŸæª”å` å‘½åï¼Œé¿å…è¦†è“‹ã€‚
3. å°‡é™„ä»¶è³‡è¨Šå¯«å…¥ `message_file`ï¼ˆåŒ…å«åŸæª”åã€å¯¦éš›è·¯å¾‘ã€å¤§å°ã€MIME Typeï¼‰ã€‚
4. é€é `GET /api/messages` æˆ– `GET /api/messages?user_id=...` å–å¾—æ­·å²è¨˜éŒ„ï¼Œæœƒä¸€ä½µå›å‚³é™„ä»¶æ¸…å–®ã€‚

å¾ŒçºŒè‹¥è¦å¢åŠ æ¬„ä½ï¼ˆä¾‹å¦‚ conversation idã€metadata JSONã€è»Ÿåˆªé™¤æ¬„ä½ç­‰ï¼‰ï¼Œè«‹åŒæ­¥æ›´æ–°æœ¬æ–‡æª”èˆ‡ `database.py`ã€‚***
